
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Talkative</title>
    <meta name="description" content="gtalk client<">
    <meta name="author" content="antoine couette">

    <!-- Le styles -->
    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet">
    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="http://twitter.github.com/bootstrap/assets/css/docs.css" rel="stylesheet">
    <link href="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.css" rel="stylesheet">
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">Talkative</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active"><a href="#">Home</a></li>
              <li><a href="#about">About</a></li>
              <li><a href="#contact">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
		<div class="row-fluid">
			<div id="contact-list" class="span2">
				<h3>Contact List</h3>
        
			</div>
			<div class="span8">
          <ul id="myTabMenu" class="nav nav-tabs">
          </ul>
           <div id="myTabContent" class="tab-content">
                
            </div>
			</div>
           
		</div>

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->


    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    

    <script type="text/javascript">
    $(function () {
      var socket = io.connect('http://localhost:3000');
        
        socket.on('presence', function (data) {
          var id = data.from.hashCode();
          if($('#menu-'+id).length==0){
            var content = '<div class="span12"><a id="menu-'+id+'" href="#">'+data.from+'</a></div>';
            var elem$ = $(content);
            elem$.click(function() {
              createChat(socket, data);
            });
            $('#contact-list').append(elem$);
            $('#contact-list').show();
          }

        });
        socket.on('message', function (data) {
          createChat(socket, data);
          var id = data.from.hashCode();
          $('#textarea-'+id).val($('#textarea-'+id).val() + '\n'+data.from+' : '+data.body);
        });
      });


      function createChat(socket, data){
        var id = data.from.hashCode();
          if($('#'+id).length==0){
            $('#myTabMenu').append('<li><a href="#'+id+'" data-toggle="tab">'+data.from+'</a></li>');
            $('#myTabContent').append('<div class="tab-pane fade in active" id="'+id+'">\
                 <p><textarea class="input-xlarge span8 chat-widget" id="textarea-'+id+'" rows="20"></textarea></p>\
                  <p><input type="text" class="input-xlarge span8 chat-widget" id="input-'+id+'" placeholder="Enter your message"></p>\
                  <p><button type="submit" class="btn btn-primary chat-widget" id="send-'+id+'">Send</button></p>\
                </div>');
            $('#myTabContent').show();
            $('#myTabMenu a:last').tab('show');
          }


          $('#send-'+id).click(function() {
            sendMsg(socket, $('#input-'+id), data.from, $('#textarea-'+id));
          });
          $('#input-'+id).keydown(function(event) {
            if (event.which == 13) {
              sendMsg(socket, $('#input-'+id), data.from, $('#textarea-'+id));
            }
          });
      }

      function sendMsg (socket, input$, to, textarea$) {
        var msgBody = input$.val();
        if(msgBody){
          socket.emit('message', {to: to, body: msgBody});
          textarea$.val(textarea$.val() + '\nme: '+msgBody);
          input$.val('');
        }
      }

      String.prototype.hashCode = function(){
        var hash = 0, i, char;
        if (this.length == 0) return hash;
        for (i = 0; i < this.length; i++) {
            char = this.charCodeAt(i);
            hash = ((hash<<5)-hash)+char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return hash;
    };

    </script>

  </body>
</html>
